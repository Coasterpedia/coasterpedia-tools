@using BitzArt.Blazor.Cookies
@inherits LayoutComponentBase

<MudThemeProvider @ref="_mudThemeProvider" Theme="Theme.ApplicationTheme()" @bind-IsDarkMode="_isDarkMode"/>
<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>

    <MudDrawer id="nav-drawer" Elevation="1" Variant="@DrawerVariant.Mini" Open="false" ClipMode="DrawerClipMode.Docked" Breakpoint="Breakpoint.None"
               Class="d-none d-md-flex">
        <MudText Align="Align.Center" Class="mt-3">
            <MudLink Href="https://coasterpedia.net">
                <MudImage Src="https://images.coasterpedia.net/0/09/Cp_pride.png" Width="32"/>
            </MudLink>
        </MudText>
        <MudNavMenu Margin="Margin.Normal">
            <MudNavLink Href="/" Icon="@Icons.Material.Filled.Apps" ActiveClass="">Home</MudNavLink>
        </MudNavMenu>
        <MudSpacer/>
        <MudNavMenu Margin="Margin.Normal" Class="mb-1">
            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.BottomRight" PopoverClass="pa-2" Modal="false">
                <ActivatorContent>
                    <MudNavLink Icon="@Icons.Material.Filled.Person" ActiveClass="">Profile</MudNavLink>
                </ActivatorContent>
                <ChildContent>
                    <ProfileMenu ScreenMode="@_screenMode" ScreenModeChanged="DarkModeToggle" />
                </ChildContent>
            </MudMenu>
        </MudNavMenu>

    </MudDrawer>
    <MudMainContent Class="ml-0 ml-md-14 pt-md-8 mb-16 mb-md-0">
        @Body
    </MudMainContent>
    <MudAppBar Elevation="1" Bottom="true" Fixed="true" Class="d-sm-flex d-md-none">
        <MudText Align="Align.Center">
            <MudLink Href="https://coasterpedia.net">
                <MudImage Src="./Cp_pride.png" Width="32" Class="mt-2"/>
            </MudLink>
        </MudText>

        <MudIconButton Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Apps">Home</MudIconButton>
        <MudSpacer/>
        <MudMenu AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudIconButton Icon="@Icons.Material.Filled.Person">Profile</MudIconButton>
            </ActivatorContent>
            <ChildContent>
                <ProfileMenu ScreenMode="@_screenMode" ScreenModeChanged="DarkModeToggle" />
            </ChildContent>
        </MudMenu>
    </MudAppBar>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private string _screenMode = "Auto";
    private bool _isDarkMode = true;
    private bool _systemDarkMode = true;
    private MudThemeProvider _mudThemeProvider;

    [Inject] ICookieService CookieService { get; init; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var color = await CookieService.GetAsync("Colour");
            _systemDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
            if (color == null)
            {
                _isDarkMode = _systemDarkMode;
            }
            else
            {
                await DarkModeToggle(color.Value);
            }

            await _mudThemeProvider.WatchSystemDarkModeAsync(OnSystemDarkModeChanged);
            StateHasChanged();
        }
    }

    private async Task OnSystemDarkModeChanged(bool newValue)
    {
        _systemDarkMode = newValue;
        if (_screenMode == "Auto")
        {
            _isDarkMode = newValue;
            StateHasChanged();
        }
        else
        {
            await DarkModeToggle(_screenMode);
        }
    }

    private async Task DarkModeToggle(string? value)
    {
        _screenMode = value;
        _isDarkMode = value switch
        {
            "Auto" => _systemDarkMode,
            "Light" => false,
            "Dark" => true,
            _ => _isDarkMode
        };
        await CookieService.SetAsync("Colour", value);
        StateHasChanged();
    }
}
